<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="|${post.title} - Tech Log|"></title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body>
<nav class="navbar" th:replace="~{main :: navbar}"></nav>

<div class="main-layout">
    <aside th:replace="~{fragments/_sidebar :: sidebarFragment}"></aside>

    <main class="main-content">
        <div class="container">
            <div class="detail-container" th:object="${post}">

                <div class="detail-header">
                    <div class="detail-category">
                        <a th:href="@{/post/list/by_category(category=*{category.name()})}" th:text="*{category.displayName}"></a>
                    </div>
                    <h1 class="detail-title" th:text="*{title}"></h1>
                    <p class="detail-summary" th:text="*{summary}"></p>
                    <div class="detail-rating" th:text="${'‚òÖ'.repeat(post.starRating)} + ${'‚òÜ'.repeat(5 - post.starRating)}"></div>
                </div>
                <div class="detail-meta">
                    <span><i data-feather="user"></i> <span th:text="*{author?.nickname}"></span></span>
                    <span><i data-feather="calendar"></i> <span th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd')}"></span></span>
                    <span><i data-feather="eye"></i> <span th:text="*{viewCount}"></span></span>
                </div>
                <div class="detail-image" th:if="*{imageUrl != null and !imageUrl.isEmpty()}">
                    <img th:src="@{|/uploads/*{imageUrl}|}" alt="ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ">
                </div>
                <div class="pros-cons-grid">
                    <div class="pros-box">
                        <p class="pre-wrap-text" th:text="*{pros}">üëç Pros</p>
                    </div>
                    <div class="cons-box">
                        <p class="pre-wrap-text" th:text="*{cons}">üëé Cons</p>
                    </div>
                </div>
                <div class="detail-content" th:utext="*{content}"></div>
                <div class="detail-actions">
                    <a sec:authorize="isAuthenticated()" href="javascript:void(0);"
                       th:data-uri="@{|/post/vote/${post.id}|}"
                       class="recommend btn">
                        <i data-feather="heart"></i> Ï∂îÏ≤ú
                        <span th:text="${#lists.size(post.voter)}"></span>
                    </a>
                    <a th:href="@{|/post/modify/${post.id}|}" class="btn btn-secondary"
                       sec:authorize="isAuthenticated()"
                       th:if="${post.author?.username == #authentication.name or #authorization.expression('hasRole(''ADMIN'')')}">
                        ÏàòÏ†ï
                    </a>
                    <a href="javascript:void(0);" th:data-uri="@{|/post/delete/${post.id}|}" class="delete btn btn-danger"
                       sec:authorize="isAuthenticated()"
                       th:if="${post.author?.username == #authentication.name or #authorization.expression('hasRole(''ADMIN'')')}">
                        ÏÇ≠Ï†ú
                    </a>
                </div>
                <div class="list-button-wrapper" style="text-align: center; margin-top: 2rem;">
                    <a th:href="@{/post/list}" class="btn btn-secondary">Î¶¨Î∑∞ Î™©Î°ùÏúºÎ°ú</a>
                </div>

                <hr class="divider">

                <div class="comment-section">
                    <h3 th:text="|ÎåìÍ∏Ä (${#lists.size(post.commentList)})|"></h3>
                    <form class="comment-form" th:action="@{|/comment/create/${post.id}|}" method="post"
                          sec:authorize="isAuthenticated()" th:if="${#lists.size(post.commentList) < 50}">
                        <textarea name="content" rows="3" placeholder="Í∞ÄÏù¥ÎìúÎùºÏù∏ÏùÑ ÏúÑÎ∞òÌïú Í∏ÄÏùÄ Í≤ΩÍ≥†ÏóÜÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§."></textarea>
                        <div class="comment-form-actions" style="text-align: right; margin-top: 0.5rem;">
                            <button type="submit" class="btn">ÎåìÍ∏Ä Îì±Î°ù</button>
                        </div>
                    </form>
                    <div class="alert-warning" th:if="${#lists.size(post.commentList) >= 50}">
                        ÎåìÍ∏Ä Í∞úÏàòÍ∞Ä 50Í∞úÎ•º Ï¥àÍ≥ºÌïòÏó¨ Îçî Ïù¥ÏÉÅ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.
                    </div>

                    <hr class="divider" th:if="${!post.commentList.isEmpty()}" style="margin: 2rem 0;">

                    <div class="comment-list">
                        <div th:each="comment : ${post.commentList}" th:if="${comment.parent == null}">
                            <div th:replace="~{::commentFragment(comment=${comment})}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<th:block th:fragment="commentFragment(comment)">
    <div th:id="|comment-${comment.id}|" th:classappend="${comment.parent != null} ? 'reply' : ''" class="comment-thread">
        <div class="comment">
            <div class="comment-author">
                <img th:if="${comment.author.profileImage != null}" th:src="@{|/uploads/${comment.author.profileImage}|}" class="comment-avatar" alt="profile">
                <th:block th:if="${comment.author.profileImage == null}">
                    <i data-feather="user-check" th:if="${comment.parent == null}"></i>
                    <i data-feather="corner-down-right" th:if="${comment.parent != null}"></i>
                </th:block>
                <strong th:text="${comment.author.nickname}"></strong>
                <time th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}"></time>
            </div>
            <div class="comment-content" th:text="${comment.content}"></div>
            <div class="comment-actions">
                <a href="javascript:void(0);" th:onclick="|showReplyForm(this, ${comment.id})|" sec:authorize="isAuthenticated()">ÎãµÍ∏Ä</a>
                <a href="javascript:void(0);" th:data-uri="@{|/comment/delete/${comment.id}|}" class="delete small" sec:authorize="isAuthenticated()" th:if="${comment.author?.username == #authentication.name or #authorization.expression('hasRole(''ADMIN'')')}">ÏÇ≠Ï†ú</a>
            </div>
        </div>
        <div class="reply-list" th:if="${!comment.children.isEmpty()}">
            <div th:each="child : ${comment.children}" th:replace="~{this :: commentFragment(comment=${child})}"></div>
        </div>
    </div>
</th:block>

<div id="reply-form-template" style="display: none;">
    <form th:action="@{|/comment/create/${post.id}|}" method="post" class="comment-form reply-form">
        <input type="hidden" name="parentId" value="">
        <textarea name="content" rows="3" placeholder="ÎãµÍ∏ÄÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî."></textarea>
        <div class="reply-form-actions">
            <button type="button" class="btn btn-secondary btn-sm" onclick="cancelReply(this)">Ï∑®ÏÜå</button>
            <button type="submit" class="btn btn-sm">Îì±Î°ù</button>
        </div>
    </form>
</div>

<script type='text/javascript'>
    // ÌéòÏù¥ÏßÄ Î°úÎî© ÏôÑÎ£å ÌõÑ, ÎãµÍ∏ÄÏù¥ 3Í∞ú Ï¥àÍ≥ºÌïòÎäî ÎåìÍ∏ÄÏóê 'ÎçîÎ≥¥Í∏∞' Î≤ÑÌäº ÎèôÏ†Å Ï∂îÍ∞Ä
    document.addEventListener('DOMContentLoaded', function() {
        // Î™®Îì† ÎåìÍ∏Ä Ïì∞Î†àÎìúÎ•º Ï∞æÏùå (ÏµúÏÉÅÏúÑ, ÎãµÍ∏Ä Ìè¨Ìï®)
        const allThreads = document.querySelectorAll('.comment-thread');

        allThreads.forEach(thread => {
            // Í∞Å Ïì∞Î†àÎìú ÏïàÏùò ÎãµÍ∏Ä Î™©Î°ùÏùÑ Ï∞æÏùå
            const replyList = thread.querySelector('.reply-list');
            if (replyList) {
                // ÎãµÍ∏Ä Î™©Î°ùÏùò ÏßÅÍ≥Ñ ÏûêÏãùÏù∏ ÎãµÍ∏ÄÎì§Îßå ÏÑ†ÌÉù
                const children = replyList.querySelectorAll(':scope > .comment-thread');
                if (children.length > 3) {
                    // 3Í∞ú Ïù¥ÌõÑÏùò ÎãµÍ∏ÄÏùÄ ÏùºÎã® Ïà®ÍπÄ
                    for (let i = 3; i < children.length; i++) {
                        children[i].style.display = 'none';
                    }
                    // 'ÎçîÎ≥¥Í∏∞' Î≤ÑÌäº ÏÉùÏÑ± Î∞è Ï∂îÍ∞Ä
                    const showMoreBtn = document.createElement('a');
                    showMoreBtn.href = 'javascript:void(0);';
                    showMoreBtn.className = 'toggle-replies-btn';
                    showMoreBtn.innerText = '... ' + (children.length - 3) + 'Í∞ú ÎãµÍ∏Ä ÎçîÎ≥¥Í∏∞';
                    showMoreBtn.onclick = function() { toggleReplies(this); };
                    replyList.appendChild(showMoreBtn);
                }
            }
        });
    });

    // ÎçîÎ≥¥Í∏∞/Ï†ëÍ∏∞ ÌÜ†Í∏Ä Ìï®Ïàò
    function toggleReplies(buttonElement) {
        const replyList = buttonElement.parentNode;
        let isHiding = true; // ÌòÑÏû¨ Ïà®Í∏∞Îäî ÎèôÏûëÏùÑ Ìï† Í≤ÉÏù∏ÏßÄ Ïó¨Î∂Ä

        // Î≤ÑÌäºÏùÑ Ï†úÏô∏Ìïú ÏûêÏãù ÏöîÏÜå(ÎãµÍ∏Ä)Îì§ÏùÑ ÏàúÌöå (length - 1 ÍπåÏßÄ)
        for(let i = 3; i < replyList.children.length - 1; i++) {
            const replyItem = replyList.children[i];
            if (replyItem.style.display === 'none') {
                replyItem.style.display = 'block';
                isHiding = false; // ÌïòÎÇòÎùºÎèÑ ÌéºÏ≥§ÏúºÎ©¥, Ï†ÑÏ≤¥ ÎèôÏûëÏùÄ 'ÌéºÏπòÍ∏∞'
            } else {
                replyItem.style.display = 'none';
            }
        }

        if (isHiding) {
            buttonElement.innerText = '... ' + (replyList.children.length - 4) + 'Í∞ú ÎãµÍ∏Ä ÎçîÎ≥¥Í∏∞';
        } else {
            buttonElement.innerText = '‚ñ≤ ÎãµÍ∏Ä Ï†ëÍ∏∞';
        }
    }

    // ÎÇòÎ®∏ÏßÄ Ï∂îÏ≤ú/ÏÇ≠Ï†ú/ÎãµÍ∏Ä Ìèº Í¥ÄÎ†® Ïä§ÌÅ¨Î¶ΩÌä∏Îäî Í∏∞Ï°¥Í≥º ÎèôÏùº
    document.addEventListener('click', function(event) {
        const deleteTarget = event.target.closest('.delete');
        if (deleteTarget) {
            if(confirm("Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                location.href = deleteTarget.dataset.uri;
            }
        }
        const recommendTarget = event.target.closest('.recommend');
        if (recommendTarget) {
            if(confirm("Ïù¥ Í∏ÄÏùÑ Ï∂îÏ≤úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                location.href = recommendTarget.dataset.uri;
            }
        }
    });

    let currentReplyForm = null;
    function showReplyForm(buttonElement, parentId) {
        const formTemplate = document.getElementById('reply-form-template');
        if (!formTemplate) return;
        const newForm = formTemplate.cloneNode(true);
        newForm.style.display = 'block';
        newForm.removeAttribute('id');
        newForm.querySelector('input[name="parentId"]').value = parentId;
        if (currentReplyForm && currentReplyForm.parentNode) {
            currentReplyForm.parentNode.removeChild(currentReplyForm);
        }
        const commentThread = buttonElement.closest('.comment-thread, .reply, .comment');
        if (commentThread) {
            commentThread.appendChild(newForm);
        }
        currentReplyForm = newForm;
    }

    function cancelReply(cancelButton) {
        const formWrapper = cancelButton.closest('.comment-form.reply-form').parentNode;
        if (formWrapper && formWrapper.parentNode) {
            formWrapper.parentNode.removeChild(formWrapper);
        }
        currentReplyForm = null;
    }

    try {
        feather.replace();
    } catch (e) {
        console.error("Feather Icons failed to load.", e);
    }
</script>

</body>
</html>